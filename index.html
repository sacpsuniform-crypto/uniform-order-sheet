<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>SA College Private School - Uniform Order</title>

  <!-- =========================
       Libraries
       - jsPDF + AutoTable for PDF generation
       ========================= -->

  <!-- jsPDF and autotable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root{
      --navy: #00274d;
      --gold: #ffc107;
      --white: #ffffff;
      --muted: #f4f6f8;
      --accent: #0f7b3a;
    }
    html,body{
      margin:0;
      padding:0;
      height:100%;
      font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: var(--muted);
      color:#111;
    }

    /* Header */
    header.site-header{
      background: linear-gradient(90deg, rgba(0,39,77,1) 0%, rgba(0,39,77,0.95) 60%);
      color:var(--white);
      padding:14px 20px;
      display:flex;
      gap:18px;
      align-items:center;
    }
    header.site-header img.logo{
      height:78px;
      width:auto;
      border-radius:8px;
      box-shadow:0 3px 8px rgba(0,0,0,0.2);
      background:var(--white);
      padding:4px;
    }
    header.site-header .heading{
      line-height:1.05;
    }
    header.site-header .heading h1{
      font-size:20px;
      margin:0;
      color:var(--white);
      letter-spacing:0.2px;
    }
    header.site-header .heading p{
      margin:3px 0 0 0;
      font-size:13px;
      color: rgba(255,255,255,0.9);
    }

    /* Braten notice below header */
    .braten-notice {
      background: var(--white);
      border: 1px solid var(--gold);
      border-left: 5px solid var(--gold);
      border-radius: 8px;
      padding: 16px 20px;
      margin: 0 auto 18px auto;
      max-width: 1200px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
      font-size: 14px;
      line-height: 1.5;
      color: #222;
    }
    .braten-notice h3 {
      margin: 0 0 10px 0;
      font-size: 16px;
      font-weight: 700;
      color: var(--navy);
    }
    .braten-notice p {
      margin: 0 0 10px 0;
    }
    .braten-notice ul {
      margin: 10px 0;
      padding-left: 20px;
    }
    .braten-notice ul li {
      margin-bottom: 8px;
    }
    .braten-notice strong {
      color: var(--navy);
    }
    .braten-notice .emoji {
      margin-right: 6px;
    }
    @media (max-width: 980px) {
      .braten-notice {
        margin: 0 10px 18px 10px;
      }
    }

    /* Page wrapper */
    .page {
      max-width:1200px;
      margin:18px auto;
      padding:10px;
    }

    /* Form layout */
    form#orderForm {
      display: grid;
      grid-template-columns: 1fr 360px;
      gap:18px;
    }

    /* Left column */
    .left {
      background:var(--white);
      border-radius:10px;
      padding:18px;
      box-shadow:0 4px 10px rgba(0,0,0,0.04);
    }
    .left .section { margin-bottom:14px; }

    .form-row { display:flex; gap:12px; margin-bottom:10px; }
    .form-row .field { flex:1; }
    label{
      display:block;
      font-size:13px;
      margin-bottom:6px;
      color:#222;
    }
    input[type="text"], input[type="email"], select {
      width:100%;
      padding:8px 10px;
      border-radius:6px;
      border:1px solid #d7dbe0;
      font-size:14px;
      box-sizing:border-box;
      background:#fff;
    }

    /* Product category cards */
    .category-card {
      border-radius:8px;
      background:linear-gradient(180deg, #ffffff 0%, #fcfcfc 100%);
      border:1px solid #e8eef7;
      padding:10px;
      margin-bottom:12px;
    }
    .category-card .cat-header{
      background:var(--navy);
      color:var(--white);
      padding:8px 10px;
      border-radius:6px;
      font-weight:700;
      margin:-10px -10px 10px -10px;
    }
    .product-row{
      display:flex;
      gap:10px;
      align-items:center;
      padding:8px 0;
      border-bottom:1px dashed #eef3fb;
    }
    .product-row:last-child{ border-bottom:none; }
    .product-row .pname { flex:1; font-weight:600; color:#222; font-size:14px; }
    .product-row select.size { width:110px; padding:6px; border-radius:6px; border:1px solid #d7dbe0; }
    .product-row input.qty { width:70px; padding:6px; border-radius:6px; border:1px solid #d7dbe0; }

    /* Size & Qty headings above products */
    .size-qty-heading {
      display:flex;
      gap:10px;
      font-weight:700;
      font-size:13px;
      margin-bottom:6px;
    }
    .size-qty-heading div {
      width: auto;
      text-align:left;
    }
    .size-qty-heading .size-col { width:110px; text-align:center; }
    .size-qty-heading .qty-col { width:70px; text-align:center; }

    /* Right column - cart */
    .cart {
      background:var(--white);
      border-radius:10px;
      padding:16px;
      box-shadow:0 4px 10px rgba(0,0,0,0.04);
      position:sticky;
      top:18px;
      height:fit-content;
      min-height:200px;
    }
    .cart h3{ margin-top:0; color:var(--navy); }
    table.cart-table{
      width:100%;
      border-collapse:collapse;
      margin-top:8px;
      font-size:14px;
    }
    table.cart-table th, table.cart-table td {
      padding:8px 6px;
      border:1px solid #e6e9ee;
      text-align:left;
    }
    table.cart-table th{
      background:var(--navy);
      color:var(--white);
      font-weight:600;
      font-size:13px;
    }
    .cart .total {
      margin-top:10px;
      font-weight:700;
      font-size:16px;
      color:#111;
    }

    /* Buttons */
    .btn {
      display:inline-block;
      padding:10px 14px;
      border-radius:8px;
      border:none;
      cursor:pointer;
      font-weight:700;
      font-size:14px;
    }
    .btn-primary {
      background:var(--navy);
      color:var(--white);
    }
    .btn-gold {
      background:var(--gold);
      color:#111;
      margin-top:12px;
      width:100%;
    }

    /* Responsive */
    @media(max-width:980px){
      form#orderForm { grid-template-columns: 1fr; }
      .cart { position:relative; top:auto; }
    }

    .muted { color:#6b7280; font-size:13px; }
    .spaced { margin-top:8px; margin-bottom:8px; }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="site-header" role="banner">
    <img class="logo" id="schoolLogo" src="logo.jpg" alt="SA College Private School logo" />
    <div class="heading">
      <h1>SA College Private School</h1>
      <p class="muted">finance@sacps.co.za ‚Ä¢ info@sacps.co.za ‚Ä¢ sacpsuniform@gmail.com ‚Ä¢ Tel: 012 326 4580 / 064 548 9428</p>
    </div>
  </header>

  <!-- Braten notice -->
  <div class="braten-notice">
    <h3>Important Uniform Order Information</h3>
    <p>SA College Private School is partnering with <strong>Reaora</strong> and <strong>N2S Suppliers</strong> to offer school uniforms and sportswear at more affordable prices for parents.</p>
    <p><strong>Note:</strong> Select Outfitters remains an approved supplier, and parents may continue purchasing from them if preferred.</p>
    <h3><span class="emoji">üóì</span> Uniform Orders</h3>
    <ul>
      <li>Orders placed before <strong>1 November 2025</strong> will be delivered to the school and handed to your child before the last day of term, ensuring readiness for January 2026 without queuing.</li>
      <li>Orders placed between <strong>1 and 30 December 2025</strong> will be delivered by <strong>9 January 2026</strong>.</li>
    </ul>
    <h3><span class="emoji">üèÖ</span> Sportswear Orders</h3>
    <ul>
      <li>All sportswear orders must be placed by <strong>15 November 2025</strong>.</li>
      <li>Expected delivery date: <strong>5 December 2025</strong>.</li>
    </ul>
  </div>

  <!-- Main content -->
  <main class="page" role="main">
    <form id="orderForm" autocomplete="off">
      <div class="left" role="region" aria-label="Order and products">
        <div class="section" id="infoSection">
          <h2 style="margin-top:0; color:var(--navy)">Parent & Learner Information</h2>
          <div class="form-row">
            <div class="field"><label for="parentName">Parent Name</label><input id="parentName" type="text" required placeholder="e.g. Thandi Mbeki"></div>
            <div class="field"><label for="contactNumber">Contact Number</label><input id="contactNumber" type="text" required placeholder="e.g. 072 000 0000"></div>
          </div>
          <div class="form-row">
            <div class="field"><label for="email">Email</label><input id="email" type="email" required placeholder="parent@example.com"></div>
            <div class="field"><label for="learnerName">Learner Name</label><input id="learnerName" type="text" required placeholder="e.g. Sipho M"></div>
          </div>
          <div class="form-row">
            <div class="field"><label for="grade">Grade</label><input id="grade" type="text" required placeholder="e.g. Grade 7A"></div>
            <div class="field"><label for="adminNumber">Admin Number</label><input id="adminNumber" type="text" required placeholder="e.g. 45125"></div>
          </div>
        </div>

        <!-- Products -->
        <div class="section" id="productsSection">
          <h2 style="margin-top:0; color:var(--navy)">Uniforms & Sports</h2>

          <!-- Reaora -->
          <div class="category-card" id="cat-reaora">
            <div class="cat-header">Reaora</div>
            <div style="display:flex; gap:16px; font-weight:700; font-size:13px; margin-bottom:8px;">
              <div style="flex:1; text-align:left;">Item</div>
              <div style="width:120px; text-align:center;">Size</div>
              <div style="width:80px; text-align:center;">Quantity</div>
            </div>
            <div class="card-body"></div>
          </div>

          <!-- N2S -->
          <div class="category-card" id="cat-n2s">
            <div class="cat-header">N2S</div>
            <div style="display:flex; gap:16px; font-weight:700; font-size:13px; margin-bottom:8px;">
              <div style="flex:1; text-align:left;">Item</div>
              <div style="width:120px; text-align:center;">Size</div>
              <div style="width:80px; text-align:center;">Quantity</div>
            </div>
            <div class="card-body"></div>
          </div>
        </div>
      </div>

      <!-- RIGHT - cart & submit -->
      <aside class="cart" role="region" aria-label="Cart and submit">
        <h3>Your Cart</h3>
        <div class="muted">Add quantities for the items on the left and the cart will update automatically.</div>
        <table class="cart-table" aria-live="polite" id="cartTable">
          <thead>
            <tr>
              <th style="width:42%;">Item</th>
              <th style="width:18%;">Size</th>
              <th style="width:10%;">Qty</th>
              <th style="width:14%;">Line</th>
              <th style="width:10%;">Remove</th>
            </tr>
          </thead>
          <tbody id="cartBody">
            <tr><td colspan="5" class="muted">No items</td></tr>
          </tbody>
        </table>

        <div class="total" id="grandTotal">Total: R0.00</div>
        <!-- üí≥ Payment Information Section -->
        <div id="payment-info" style="margin-top: 30px; border: 2px solid #169179; border-radius: 10px; background-color: #f2faf8; padding: 20px; font-family: 'Comic Sans MS', sans-serif;">
          <h3 style="background-color: #ba372a; color: white; padding: 10px; border-radius: 8px 8px 0 0; margin-top: 0;">
            üí≥ Payment Information
          </h3>
          <p>After submitting your order, please make an <strong>EFT payment</strong> to the normal account.</p>
          <p>Use <strong>‚ÄúUniform ‚Äì [Admin number-Child‚Äôs Name]‚Äù</strong> as your payment reference.</p>
          <p>Then email your <strong>proof of payment and order receipt</strong> to:</p>
          <p style="margin-left: 20px;">
            üìß <a href="mailto:finance@sacps.co.za">finance@sacps.co.za</a> or 
            <a href="mailto:info@sacps.co.za">info@sacps.co.za</a> or <a href="mailto:sacpsuniform@gmail.com">sacpsuniform@gmail.com</a>  
          </p>
        </div>
        <!-- Submit button -->
        <button type="submit" class="btn btn-gold" id="submitBtn" style="margin-top:14px;">
          Submit Order & Download Receipt
        </button>

        <div class="spaced muted" style="font-size:13px;">
          After submitting, a PDF receipt will download for the parent.
        </div>
      </aside>
    </form>
  </main>

  <!-- =========================
       Script: Data, render, cart, PDF
       ========================= -->
  <script>
    (function(){
      // ---------------------------
      // Data: sizes & items
      // ---------------------------
      const primarySizes = ['5-6','6-7','7-8','8-9','9-10','10-11','11-12','12-13','13-14'];
      const highschoolSizes = ['13-14','14-15','15-16','16-17','17-18','18-20'];
      const blazerSizes = ['28','30','32','34','36','38','40','42'];
      const oneSize = ['One Size'];
      const allSizes = [...primarySizes, ...highschoolSizes];

      function increase10pct(price){ return Math.round(price * 1.1); }
      // All items - unchanged from your working list, grouped here for clarity
      const categories = {
        "Reaora": [
          {id:"tracksuit_primary",name:"Primary Tracksuit Set",price:660,sizes:primarySizes},
          {id:"tracksuit_hs",name:"Highschool Tracksuit Set",price:715,sizes:highschoolSizes},
          {id:"ts_jacket_primary",name:"Primary Tracksuit Jacket",price:440,sizes:primarySizes},
          {id:"ts_jacket_hs",name:"Highschool Tracksuit Jacket",price:495,sizes:highschoolSizes},
          {id:"ts_pants_primary",name:"Primary Tracksuit Pants",price:220,sizes:primarySizes},
          {id:"ts_pants_hs",name:"Highschool Tracksuit Pants",price:220,sizes:highschoolSizes},
          {id:"jersey_hs",name:"Highschool Jersey",price:285,sizes:highschoolSizes},
          {id:"jersey_primary",name:"Primary Jersey",price:275,sizes:primarySizes},
          {id:"pullover_hs",name:"Highschool Pullover",price:265,sizes:highschoolSizes},
          {id:"pullover_primary",name:"Primary Pullover",price:255,sizes:primarySizes},
          {id:"blazer",name:"Blazer",price:770,sizes:blazerSizes},
          {id:"tie",name:"School Tie",price:90,sizes:oneSize},
          {id:"skirt_primary",name:"Primary Girls Skirt",price:375,sizes:primarySizes},
          {id:"skirt_hs",name:"Highschool Girls Skirt",price:400,sizes:highschoolSizes},
          {id:"sport_shirt",name:"Sport Shirt",price:380,sizes:allSizes},
          {id:"sport_short",name:"Sport Short",price:110,sizes:allSizes},
          {id:"matric_bomber",name:"Matric Bomber Jacket",price:715,sizes:highschoolSizes},
          {id:"green_socks",name:"Long Green Socks",price:60,sizes:oneSize},
          {id:"floppy_hat",name:"Floppy Hat",price:175,sizes:oneSize},
          {id:"beanie",name:"Beanie",price:55,sizes:oneSize}
        ],
        "N2S": [
          {id:"soccer_shirt",name:"Soccer Shirt",price:295,sizes:allSizes},
          {id:"soccer_short",name:"Soccer Short",price:285,sizes:allSizes},
          {id:"soccer_socks",name:"Soccer Socks",price:110,sizes:allSizes},
          {id:"rugby_jersey",name:"Rugby Jersey",price:395,sizes:allSizes},
          {id:"rugby_short",name:"Rugby Short",price:275,sizes:allSizes},
          {id:"rugby_socks",name:"Rugby Socks",price:110,sizes:allSizes},
          {id:"basketball_shirt",name:"Basketball Shirt",price:285,sizes:allSizes},
          {id:"basketball_short",name:"Basketball Short",price:285,sizes:allSizes},
          {id:"netball_dress",name:"Netball Dress",price:310,sizes:allSizes},
          {id:"athletics_vest",name:"Athletics Vest",price:275,sizes:allSizes},
          {id:"athletics_short",name:"Athletics Short",price:265,sizes:allSizes}
        ]
      };

      const imageMap = {
        "athletics_short": "athletics short.jpg",
        "athletics_vest": "athletics vest.jpg",
        "basketball_shirt": "basketball shirt.jpg",
        "basketball_short": "basketball shorts.jpg",
        "netball_dress": "netball dress.jpg",
        "rugby_jersey": "rugby jersey.jpg",
        "rugby_short": "rugby short.jpg",
        "rugby_socks": "rugby socks.jpg",
        "soccer_shirt": "soccer shirt.jpg",
        "soccer_short": "soccer short.jpg",
        "soccer_socks": "soccer socks.jpg"
      };

      // ---------------------------
      // Rendering: inject products into their category cards
      // ---------------------------
      function createProductRow(item){
        // container row
        const row = document.createElement('div');
        row.className = 'product-row item-row';
        row.dataset.itemId = item.id;
        row.dataset.price = item.price;

        // name
        const nameSpan = document.createElement('div');
        nameSpan.className = 'pname';
        nameSpan.textContent = `${item.name} ‚Äî R${item.price}`;

        if(imageMap[item.id]){
          const img = document.createElement('img');
          img.src = imageMap[item.id];
          img.alt = `${item.name} image`;
          img.style.height = '60px';
          img.style.marginLeft = '10px';
          img.style.verticalAlign = 'middle';
          nameSpan.appendChild(img);
        }

        // size selector
        const sizeSel = document.createElement('select');
        sizeSel.className = 'size';
        item.sizes.forEach(s=>{
          const opt = document.createElement('option');
          opt.value = s;
          opt.textContent = s;
          sizeSel.appendChild(opt);
        });

        // qty input
        const qtyInput = document.createElement('input');
        qtyInput.className = 'qty';
        qtyInput.type = 'number';
        qtyInput.min = 0;
        qtyInput.value = 0;
        qtyInput.setAttribute('aria-label', `${item.name} quantity`);

        row.appendChild(nameSpan);
        row.appendChild(sizeSel);
        row.appendChild(qtyInput);

        return row;
      }

      // find category card bodies and append items
      try {
        // mapping card ids -> category keys
        const mapping = {
          "cat-reaora": "Reaora",
          "cat-n2s": "N2S"
        };

        Object.entries(mapping).forEach(([cardId, catKey])=>{
          const el = document.querySelector('#' + cardId + ' .card-body');
          if(!el) return;
          categories[catKey].forEach(item=>{
            el.appendChild(createProductRow(item));
          });
        });
      } catch (err) {
        console.error("Error building product list:", err);
      }

      // ---------------------------
      // Cart: collect selected items & render
      // ---------------------------
      let cart = [];

      function collectCartFromDOM(){
        cart = [];
        document.querySelectorAll('.item-row').forEach(row=>{
          const qty = parseInt(row.querySelector('.qty').value || 0, 10);
          if(qty > 0){
            const fullName = row.querySelector('.pname').textContent || row.querySelector('.item-name')?.textContent;
            // some rows may use former naming; guard with fallback
            const name = (fullName || 'Item').split(' ‚Äî ')[0].trim();
            const size = row.querySelector('.size').value;
            const price = parseFloat(row.dataset.price);
            cart.push({ name, size, qty, price });
          }
        });
      }

      function renderCart(){
        const tbody = document.getElementById('cartBody');
        tbody.innerHTML = '';
        if(cart.length === 0){
          const tr = document.createElement('tr');
          const td = document.createElement('td');
          td.colSpan = 5;
          td.className = 'muted';
          td.textContent = 'No items';
          tr.appendChild(td);
          tbody.appendChild(tr);
          document.getElementById('grandTotal').textContent = "Total: R0.00";
          return;
        }

        let grand = 0;
        cart.forEach((it, idx) => {
          const tr = document.createElement('tr');

          // item cell
          const tdItem = document.createElement('td');
          tdItem.textContent = it.name;

          // size cell
          const tdSize = document.createElement('td');
          tdSize.textContent = it.size;

          // qty
          const tdQty = document.createElement('td');
          tdQty.textContent = it.qty;

          // line
          const line = it.qty * it.price;
          grand += line;
          const tdLine = document.createElement('td');
          tdLine.textContent = `R${line.toFixed(2)}`;

          // remove
          const tdRemove = document.createElement('td');
          const removeBtn = document.createElement('button');
          removeBtn.className = 'btn btn-primary';
          removeBtn.style.padding = '4px 6px';
          removeBtn.style.background = '#fff';
          removeBtn.style.color = '#d9534f';
          removeBtn.style.border = '1px solid #f0a3a3';
          removeBtn.textContent = 'X';
          removeBtn.dataset.index = idx;
          removeBtn.addEventListener('click', function(e){
            e.preventDefault();
            cart.splice(this.dataset.index, 1);
            // Also set the corresponding qty input in the DOM to 0
            // Find matching item and reset qty (best-effort by name & size)
            document.querySelectorAll('.item-row').forEach(r=>{
              const name = r.querySelector('.pname').textContent.split(' ‚Äî ')[0].trim();
              const size = r.querySelector('.size').value;
              if(name === it.name && size === it.size){
                r.querySelector('.qty').value = 0;
              }
            });
            collectCartFromDOM();
            renderCart();
          });
          tdRemove.appendChild(removeBtn);

          tr.appendChild(tdItem);
          tr.appendChild(tdSize);
          tr.appendChild(tdQty);
          tr.appendChild(tdLine);
          tr.appendChild(tdRemove);
          tbody.appendChild(tr);
        });

        document.getElementById('grandTotal').textContent = `Total: R${grand.toFixed(2)}`;
      }

      // update cart whenever a qty or size changes
      document.addEventListener('input', function(e){
        if(e.target.classList && (e.target.classList.contains('qty') || e.target.classList.contains('size'))){
          collectCartFromDOM();
          renderCart();
        }
      });

      // ---------------------------
      // PDF generation
      // - includes logo if available (attempts to add image)
      // - uses school colours for header
      // ---------------------------
      async function createReceiptPDF(details, cartItems){
        // details: { parentName, contactNumber, email, learnerName, grade, adminNumber }
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ unit: 'pt', format: 'a4' });

        // --- Header band with colours & logo ---
        const pageWidth = doc.internal.pageSize.getWidth();
        // draw a navy rectangle
        doc.setFillColor(0, 39, 77); // navy
        doc.rect(0, 0, pageWidth, 70, 'F');

        // try to include logo (falls back gracefully)
        try {
          const logoImg = document.getElementById('schoolLogo');
          if(logoImg && logoImg.complete){
            // convert image to data URL via canvas to ensure compatibility
            const canvas = document.createElement('canvas');
            canvas.width = logoImg.naturalWidth;
            canvas.height = logoImg.naturalHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(logoImg, 0, 0);
            const imgData = canvas.toDataURL('image/png');
            doc.addImage(imgData, 'PNG', 18, 12, 46, 46);
          }
        } catch(err){
          console.warn('Could not add logo to PDF:', err);
        }

        // School title
        doc.setFontSize(16);
        doc.setTextColor(255,255,255);
        doc.text("SA College Private School", 80, 28);

        // Receipt title on gold
        doc.setFillColor(255,193,7); // gold
        doc.rect(pageWidth - 200, 18, 180, 30, 'F');
        doc.setFontSize(11);
        doc.setTextColor(0,0,0);
        doc.text("Uniform Order Receipt", pageWidth - 190, 38);

        // Body text
        doc.setFontSize(10);
        doc.setTextColor(35,35,35);
        const left = 18;
        let y = 100;
        doc.text(`Parent: ${details.parentName}`, left, y); y += 16;
        doc.text(`Contact: ${details.contactNumber}`, left, y); y += 16;
        doc.text(`Email: ${details.email}`, left, y); y += 16;
        doc.text(`Learner: ${details.learnerName}`, left, y); y += 16;
        doc.text(`Grade: ${details.grade}`, left, y); y += 16;
        doc.text(`Admin Number: ${details.adminNumber}`, left, y); y += 26;

        // Build table array for autoTable
        const tableBody = cartItems.map(it => [it.name, it.size, String(it.qty), `R${it.price}`, `R${(it.qty*it.price).toFixed(2)}`]);

        // If no items, put a placeholder row
        if(tableBody.length === 0) tableBody.push(['No items','','','','']);

        // Add table using autoTable
        doc.autoTable({
          startY: y,
          head: [['Item', 'Size', 'Qty', 'Unit Price', 'Line Total']],
          body: tableBody,
          styles: { fontSize: 10, cellPadding: 6 },
          headStyles: { fillColor: [0,39,77], textColor: 255, halign: 'center' },
          theme: 'grid',
          margin: { left: 12, right: 12 }
        });

        // Grand total
        const finalY = doc.lastAutoTable ? doc.lastAutoTable.finalY : y + 120;
        const grand = cartItems.reduce((s, it) => s + (it.price * it.qty), 0);
        doc.setFontSize(11);
        doc.setTextColor(0,0,0);
        doc.text(`Grand Total: R${grand.toFixed(2)}`, 18, finalY + 18);

        // Footer with school contact
        doc.setFontSize(9);
        doc.setTextColor(120,120,120);
        doc.text("SA College Private School ‚Ä¢ finance@sacps.co.za ‚Ä¢ Tel: 012 326 4580 / 064 548 9428", 18, doc.internal.pageSize.getHeight() - 30);

        // Return the jsPDF doc object and a base64 string for attaching if desired
        return {
          doc,
          dataUrl: doc.output('datauristring'), // datauri (useful for inline preview)
          base64: doc.output('dataurlstring') // this returns data:application/pdf;filename=generated.pdf;base64,....
        };
      }

      // ---------------------------
      // Submit: generate PDF, download
      // ---------------------------
      document.getElementById('orderForm').addEventListener('submit', async function(e){
        e.preventDefault();

        // Disable submit to avoid double submissions
        const submitBtn = document.getElementById('submitBtn');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Processing...';

        try {
          // gather form details and cart
          const parentName = document.getElementById('parentName').value.trim();
          const contactNumber = document.getElementById('contactNumber').value.trim();
          const email = document.getElementById('email').value.trim();
          const learnerName = document.getElementById('learnerName').value.trim();
          const grade = document.getElementById('grade').value.trim();
          const adminNumber = document.getElementById('adminNumber').value.trim();

          // collect cart items from DOM
          collectCartFromDOM();
          if(cart.length === 0){
            alert('Please add at least one uniform item before submitting.');
            submitBtn.disabled = false;
            submitBtn.textContent = 'Submit Order & Download Receipt';
            return;
          }

          const details = { parentName, contactNumber, email, learnerName, grade, adminNumber };

          // create PDF
          const { doc } = await createReceiptPDF(details, cart);

          // prompt download for parent
          try {
            const fileName = `SACollege_Receipt_${learnerName || 'Order'}.pdf`;
            // save the file locally for parent
            doc.save(fileName);
          } catch (err){
            console.warn('PDF download failed locally:', err);
          }

          alert("Order submitted successfully. Receipt downloaded. Please follow the payment instructions and email your proof of payment along with the receipt.");
          // reset form and cart
          document.getElementById('orderForm').reset();
          // clear all qty inputs
          document.querySelectorAll('.item-row .qty').forEach(q => q.value = 0);
          collectCartFromDOM();
          renderCart();

        } catch (err) {
          console.error("Submit error:", err);
          alert("An error occurred while submitting. Please try again.");
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Submit Order & Download Receipt';
        }
      });

      // Small UX improvement: allow pressing Enter in any field to submit (native form)
      // handled by form submit above.

      // Ensure cart is rendered initially (shows 'No items')
      collectCartFromDOM();
      renderCart();

      // Expose useful functions for debugging from console (optional)
      window._sa_helpers = {
        collectCartFromDOM, renderCart, createReceiptPDF, categories, cart
      };

    })();
  </script>

  <!-- =========================
       End file
       ========================= -->
</body>
</html>
